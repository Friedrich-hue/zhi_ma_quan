## Phase 05｜微信小程序适配与交付前开发加固

### 目标
- 在不重写业务的前提下，将 Phase 01-04 的能力 **复用到微信小程序**
- 跑通小程序侧最小闭环：登录 → 下单 → 支付 → 查单 → 管理端履约
- 在上线前补齐“开发层面必需”的稳定性与可维护性（分环境配置、错误上报、关键埋点）

### 本阶段交付物
- 小程序端可用版本（编译目标为微信小程序）
- 小程序登录（`wx.login`）对接后端并建立登录态
- 小程序支付与服务端支付单创建/回调闭环一致（支付网关仍为 Fiuu）
- 端侧差异被封装在适配层：同一套业务用例可在 H5/小程序运行
- 基础可观测性：关键日志、错误上报（占位）、关键事件埋点（占位）

### 开发范围
- **运行环境分流**
  - 统一封装：`env.platform`（h5/wechat_mp/其他）
  - 统一封装：`login_adapter`、`payment_adapter`，屏蔽端差异
- **小程序登录**
  - 前端：调用 `wx.login` 获取 code
  - 后端：code 换取 openid/unionid（或走 uni-id 小程序登录能力），绑定/创建用户，返回 token/session
- **小程序支付**
  - 复用 Phase 03 的 `pay.create`/`pay.notify`/`pay.query` 设计
  - 前端：统一走 `payment_adapter` 发起支付（可能是 `wx.requestPayment`，也可能是跳转/打开网关收银台，取决于 Fiuu 开通的能力）
  - 服务端：返回小程序端所需的“支付动作参数”（例如：`pay_type=wx_request_payment|redirect` + 对应参数）
  - 小程序侧不依赖 Return URL：最终状态仍以 Notify/Callback + 查单为准
- **UI/交互适配**
  - 导航栏、返回行为、授权提示、空态与加载态在小程序内体验一致

### 关键设计约定（建议）
- **接口不分端**：业务接口保持一致；仅登录与支付唤起参数随端差异化
- **支付渠道枚举**：`wechat_h5_jsapi`、`wechat_mp_jsapi`（或更通用命名），方便统计与排障
- **配置分环境**：dev/test/prod 的 appId、回调地址、支付参数全部走配置中心（只在开发中实现读取与校验）

### 任务拆解
- **客户端（小程序）**
  - 适配层
    - `login_adapter.wechat_mp_login()`：封装 `wx.login` + 后端换 token
    - `payment_adapter.wechat_mp_pay()`：封装 `wx.requestPayment`
  - 页面/组件兼容性修复
    - 支付回跳：小程序无“浏览器回跳”概念，统一走“支付完成后查单并跳转订单详情”
    - 兼容小程序限制：部分 H5 API/行为替换为 `uni`/`wx` 等价实现
- **后端（UniCloud）**
  - 小程序登录接口：接入 code 交换与用户绑定（可与 Phase 01 OAuth 并存）
  - 支付创建：支持小程序所需参数返回（与 H5 渠道区分）
  - 回调与查单逻辑保持一致（幂等与金额校验不变）
- **通用加固（开发层面）**
  - 错误上报占位（Sentry/自建/uniCloud 日志均可，先把采集点与开关做出来）
  - 关键埋点占位：`login_success`、`order_created`、`pay_create`、`pay_success`、`pay_failed`
  - 配置自检：启动时校验关键配置缺失并给出明确报错（避免“上线才发现没配”）

### 验收标准（开发验收）
- 小程序端可以完成一次完整购买闭环（与 H5 相同的业务结果）
- 同一后端订单/支付逻辑可同时服务 H5 与小程序（不出现分叉代码不可维护）
- 支付成功后最终状态以服务端为准，小程序端查单确认 `PAID`
- 关键日志/埋点/错误上报开关可用（至少能在测试环境观察到事件）

